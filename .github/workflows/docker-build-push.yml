name: Build and Push Docker Images

on:
  push:
    tags:
      - '*'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 需要完整历史记录以获取 tag 信息

      - name: Verify tag is on master branch
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "Tag name: $TAG_NAME"

          # 检查 tag 指向的提交是否在 master 分支上
          git fetch origin master:master || true
          if git merge-base --is-ancestor HEAD origin/master 2>/dev/null || git branch -r --contains HEAD | grep -q "origin/master"; then
            echo "Tag $TAG_NAME is on master branch"
          else
            echo "Warning: Tag $TAG_NAME may not be on master branch, continuing anyway..."
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          GIT_COMMIT=$(git rev-parse HEAD)
          GIT_DATE=$(git show -s --format='%ct')

          # 获取当前 tag 名称
          TAG_NAME=${GITHUB_REF#refs/tags/}

          # 同时使用 commit SHA 和 tag 作为标签
          IMAGE_TAGS="${GIT_COMMIT},${TAG_NAME}"

          echo "GIT_COMMIT=${GIT_COMMIT}" >> $GITHUB_OUTPUT
          echo "GIT_DATE=${GIT_DATE}" >> $GITHUB_OUTPUT
          echo "IMAGE_TAGS=${IMAGE_TAGS}" >> $GITHUB_OUTPUT
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT

          echo "Building images with tags: ${IMAGE_TAGS}"

      - name: Install just
        uses: taiki-e/install-action@just

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Build contracts and copy artifacts
        working-directory: op-deployer
        run: |
          echo "Building contracts..."
          just build-contracts
          echo "Copying contract artifacts..."
          just copy-contract-artifacts
          echo "Contract artifacts prepared successfully"

      - name: Build and push Docker images
        env:
          REGISTRY: ghcr.io
          REPOSITORY: ${{ github.repository }}
          GIT_COMMIT: ${{ steps.meta.outputs.GIT_COMMIT }}
          GIT_DATE: ${{ steps.meta.outputs.GIT_DATE }}
          IMAGE_TAGS: ${{ steps.meta.outputs.IMAGE_TAGS }}
        run: |
          docker buildx bake \
            --progress plain \
            --push \
            -f docker-bake.hcl \
            op-node op-batcher op-proposer op-challenger op-dispute-mon op-supervisor

      - name: Summary
        run: |
          echo "### Docker Images Built and Pushed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Images pushed to: \`ghcr.io/${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tags: \`${{ steps.meta.outputs.IMAGE_TAGS }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Components:" >> $GITHUB_STEP_SUMMARY
          echo "- op-node" >> $GITHUB_STEP_SUMMARY
          echo "- op-batcher" >> $GITHUB_STEP_SUMMARY
          echo "- op-proposer" >> $GITHUB_STEP_SUMMARY
          echo "- op-challenger" >> $GITHUB_STEP_SUMMARY
          echo "- op-dispute-mon" >> $GITHUB_STEP_SUMMARY
          echo "- op-supervisor" >> $GITHUB_STEP_SUMMARY
